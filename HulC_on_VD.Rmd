---
title: "HulC on VD"
output:
  html_document:
    code_folding: show
    highlight: haddock
    number_sections: yes
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
    df_print: paged
  pdf_document:
    number_sections: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = T, eval = T, warning = F, message=F)
pacman::p_load(dplyr, grf, sandwich, skimr,
               lmtest, SuperLearner, ranger, gbm, xgboost, glmnet,
               KernelKnn)
source("utilities.R")
```

\pagebreak

This file to reproduce the data analysis on the First Steps program of V\&D (2021) and to compare the confidence interval by their approach and HulC.


```{r}
# copying from VD's code
kc <- read.table("KingCounty2001.data",header=F)
# head(kc)
colnames(kc) <- c("gender","plural","age","race","parity","married","bwt","smokeN","drinkN","firstep","welfare","smoker","drinker","wpre","wgain","education","gestation")
kc$paritycat <- ifelse(kc$parity>1,2,kc$parity)

# set race and paritycat as factors
cols_to_factor <- c("firstep", "race", "paritycat", "smoker", "gender", "married")
# cols_to_factor <- c("race", "paritycat")
kc[cols_to_factor] <- lapply(kc[cols_to_factor], factor)

# low weight
kc$lbw <- ifelse(kc$bwt<2500,1,0)
```

```{r hyperparam}
alpha <- .05
ci_level <- 1-alpha
SL.library <- c("SL.glm","SL.ranger",
                # SL.svm does not work
                # "SL.svm", 
                "SL.gam",
                "SL.glm.interaction","SL.kernelKnn",
                paste("SL.gam.", 3:10, sep = ""))
```


# EDA

Variable Name | Variable | Description
---------|---------|-------------------
bwt | Infant birth weight (in grams) | Response variable
firstep | first\_step | First steps program participation
age | maternal age | 
gender | child’s sex |
race | race  | asian, black, hispanic, white or other
smoker | smoking status |
paritycat | number of previous live born infants
married | marital status |
wpre | weight prior to pregnancy |
education | education year | 

```{r}
kc %>% 
  select(bwt, firstep, age, gender, race, paritycat, married, smoker, wpre, education) %>%
  skim()
```

# Linear model

The authors consider a linear model with and without interaction between the participation on the first step program and maternal age.

## Full model

```{r}
# Y: infant birth weight (in grams)
# X: participation onthe First Steps program, maternal age, child’s sex, mother’s age, race (asian, black, hispanic, white or other), smoking status and marital status
formula_lm <- bwt ~ firstep+age+gender+race+paritycat+married+smoker+wpre+education
# lm
fit_lm <- lm(formula_lm, kc)
confint(fit_lm, 'firstep', level = ci_level)

# HulC
HulC(kc, FUN = lm, formula = formula_lm) %>%
  filter(coef == "firstep")
```

## Age

```{r}
formula_lm <- bwt ~ age+gender+race+paritycat+married+smoker+wpre+education
# lm
fit_lm <- lm(formula_lm, kc)
confint(fit_lm, 'age', level = ci_level)

# HulC
HulC(kc, FUN = lm, formula = formula_lm) %>%
  filter(coef == "age")
```

## Unadjusted for covariates

```{r}
formula_lm <- bwt ~ firstep
# lm
fit_lm <- lm(formula_lm, kc)
confint(fit_lm, 'firstep', level = ci_level)

# HulC
HulC(kc, FUN = lm, formula = formula_lm) %>%
  filter(coef == "firstep")
```


## Interaction

```{r}
formula_int <- bwt~firstep+age+firstep*age+gender+race+paritycat+married+smoker+wpre+education

vars <- c('firstep', 'age', 'firstep:age')
# lm with interaction
fit_lm <- lm(formula_int, kc)
confint(fit_lm, vars, level = ci_level)

# HulC
HulC(kc, FUN = lm, formula = formula_int) %>%
  filter(coef %in% vars)
```

# GLM

Similarly, the author repeated the analysis after dichotomising the outcome (an infant was considered to have low birth weight if they weighed < 2,500g).

## Full model

```{r}
formula_glm <- lbw~firstep+age+gender+race+paritycat+married+smoker+wpre+education
# glm
fit_glm <- glm(formula_glm, kc, family = "binomial")
confint(fit_glm, 'firstep', level = ci_level)

# HulC
HulC(kc, FUN = glm, formula = formula_glm, family = "binomial") %>%
  filter(coef == "firstep")
```

## Age

```{r}
formula_glm <- lbw ~ age+gender+race+paritycat+married+smoker+wpre+education
# lm
fit_glm <- glm(formula_glm, kc, family = "binomial")
confint(fit_glm, 'age', level = ci_level)

# HulC
HulC(kc, FUN = glm, formula = formula_glm, family = "binomial") %>%
  filter(coef == "age")
```

## Unadjusted for covariates

```{r}
formula_glm <- lbw ~ firstep
# lm
fit_glm <- glm(formula_glm, kc, family = "binomial")
confint(fit_glm, 'firstep', level = ci_level)

# HulC
HulC(kc, FUN = glm, formula = formula_glm, family = "binomial") %>%
  filter(coef == "firstep")
```


## Interaction 

```{r}
formula_int <- lbw~firstep+age+firstep*age+gender+race+paritycat+married+smoker+wpre+education

vars <- c('firstep', 'age', 'firstep:age')
# lm with interaction
fit_glm <- glm(formula_int, kc, family = "binomial")
confint(fit_glm, vars, level = ci_level)

# HulC
HulC(kc, FUN = glm, formula = formula_int, family = "binomial") %>%
  filter(coef %in% vars)
```

# Nonparametric

Assume
\[g\{E(Y|A,L)\} = \beta A + \omega(L)\], 
the authors tried the "partialling out" estimator of Robinson (1988) and their proposal. All the nuisance are estimated using the `grf` package. They did not specify how they choose the tuning parameters so I assume they used the default.


## "partialling out" estimator of Robinson (1988)

\[\frac{\sum_{i=1}^n \{A_i - \hat{E}(A_i | L_i) \}\{Y_i - \hat{E}(Y_i |L_i) \} }{\sum_{i=1}^n \{A_i - \hat{E}(A_i | L_i) \}^2}\]
where the nuisances are estimated using `SuperLearner`.

### Full model

```{r}
formula <- bwt ~ age+gender+race+paritycat+married+smoker+wpre+education

partialling_out_estimator(kc, formula = formula, 
                          Y_var = "bwt", A_var = "firstep",
                          SL.library = SL.library)

HulC(kc, FUN = partialling_out_estimator,
     formula = formula, Y_var = "bwt", A_var = "firstep",
     SL.library = SL.library)
```

### Age

```{r}
formula <- bwt ~ gender+race+paritycat+married+smoker+wpre+education

partialling_out_estimator(kc, formula = formula, 
                          Y_var = "bwt", A_var = "age",
                          SL.library = SL.library)

HulC(kc, FUN = partialling_out_estimator,
     formula = formula, Y_var = "bwt", A_var = "age",
     SL.library = SL.library)
```

### Interaction

```{r, eval = F}
formula_int <- bwt~firstep+age+firstep*age+gender+race+paritycat+married+smoker+wpre+education

vars <- c('firstep', 'age', 'firstep:age')
# lm with interaction
fit_lm <- lm(formula_int, kc)
confint(fit_lm, vars, level = ci_level)

# HulC
HulC(kc, FUN = lm, formula = formula_int) %>%
  filter(coef %in% vars)
```


## VD proposal


Copying from Page 15

1. Obtain the estimates $\hat{E}(A|L)$ and $\hat{E}(Y|A,L)$, e.g. using machine learning.
2. If $A$ is binary, estimate $E[g\{E(Y |A, L)\}|L]$ as
\[\hat{E}[g\{\hat{E}(Y |A, L)\}|L] = g\{\hat{E}(Y |A = 1, L)\}\hat{E}(A|L) + g\{\hat{E}(Y |A = 0, L)\}\{1 - \hat{E}(A|L)\}\]
otherwise, use an additional machine learning fit (with $g\{\hat{E}(Y |A, L)\}$ as outcome).
3. Obtain an estimate of $\mu(Y, A, L)$:
\[\hat{\mu}(Y, A, L) = g^{-1}\{\hat{E}(Y |A, L)\}\{Y - \hat{E}(Y |A, L)\} +g\{\hat{E}(Y |A, L)\} - \hat{E}[g\{\hat{E}(Y |A, L)\}|L].\]
4. Fit a linear regression of $\mu(Y, A, L)$ on the sole predictor $A - \hat{E}(A|L)$ (without an intercept) using OLS in order to obtain an estimate $\hat{\beta}$ of $\beta$.

The variance is estimated through the sandwich estimator.

### Full model 

```{r}
formula <- lbw ~ age+gender+race+paritycat+married+smoker+wpre+education

VD(kc, formula = formula, 
   Y_var = "lbw", A_var = "firstep",
   SL.library = SL.library)

HulC(kc, FUN = VD, 
     formula = formula, 
     Y_var = "lbw", A_var = "firstep",
     SL.library = SL.library)
```


### Age

```{r}
formula <- lbw ~ gender+race+paritycat+married+smoker+wpre+education

VD(kc, formula = formula, 
   Y_var = "lbw", A_var = "age",
   SL.library = SL.library)

HulC(kc, FUN = VD,
     formula = formula, Y_var = "lbw", A_var = "age",
     SL.library = SL.library)
```


